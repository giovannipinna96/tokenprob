# üé® Visualization Issues Report

Questo documento descrive i problemi critici identificati nel sistema di visualizzazione dei risultati di rilevamento errori.

**Data**: 2025-01-19
**Analisi**: Revisione completa del codice senza esecuzione
**Impatto**: CRITICO - Impossibile visualizzare i token individuali evidenziati per ogni metodo

---

## üìã Indice dei Problemi

1. [PROBLEMA #1: Manca visualizzazione token-level per ogni metodo](#problema-1-manca-visualizzazione-token-level-per-ogni-metodo-critico) ‚≠ê‚≠ê‚≠ê **PRIORIT√Ä MASSIMA**
2. [PROBLEMA #2: Manca index.html principale](#problema-2-manca-indexhtml-principale-alto) ‚≠ê‚≠ê **PRIORIT√Ä ALTA**
3. [PROBLEMA #3: Nessuna integrazione tra visualizer.py e advanced methods](#problema-3-nessuna-integrazione-tra-visualizerpy-e-advanced-methods-alto) ‚≠ê‚≠ê **PRIORIT√Ä ALTA**
4. [‚úÖ OK: Logica di evidenziazione token √® corretta](#ok-logica-di-evidenziazione-token-√®-corretta) ‚úÖ

---

## PROBLEMA #1: Manca visualizzazione token-level per ogni metodo (CRITICO)

### üî¥ Problema Identificato

**Gravit√†**: üî¥ **CRITICO**

Non esiste una visualizzazione HTML che mostra **i singoli token evidenziati** per ogni metodo avanzato su ogni programma di test.

### ‚ùå Cosa Manca

**Visualizzazioni Token-Level Richieste**:

Per ogni programma (es. `binary_search_missing_bounds`), servono visualizzazioni che mostrano il **CODICE con TOKEN EVIDENZIATI** per:

1. **LecPrompt** (baseline) - Buggy version
2. **LecPrompt** (baseline) - Correct version
3. **Semantic Energy** - Buggy version
4. **Semantic Energy** - Correct version
5. **Conformal Prediction** - Buggy version
6. **Conformal Prediction** - Correct version
7. **Attention Anomaly** - Buggy version
8. **Attention Anomaly** - Correct version

**Totale per 10 programmi**: 10 √ó 4 metodi √ó 2 versioni = **80 visualizzazioni HTML**

### üìÅ Cosa Esiste Attualmente

**File**: `comparison/advanced_visualizer.py`

Genera solo **7 visualizzazioni comparative**:

| # | Tipo | File | Contenuto |
|---|------|------|-----------|
| 1 | Heatmap | `methods_comparison_heatmap.html` | Matrice metodi √ó esempi (conferma ipotesi) |
| 2 | Bar Chart | `anomaly_counts_comparison.html` | Conteggi anomalie (buggy vs correct) |
| 3 | Agreement | `method_agreement_matrix.html` | Jaccard similarity tra metodi |
| 4 | Token View | `token_level_multimethod_view_{example}.html` | **Solo bar chart, NON token evidenziati** |
| 5 | Radar | `method_performance_radar.html` | Performance multi-dimensionale |
| 6 | Venn | `venn_diagram_overlap.html` | Livelli di consenso |
| 7 | Explorer | `interactive_method_explorer.html` | Dashboard interattivo |

**Problema**: Nessuna di queste mostra i **token individuali evidenziati**!

### üîç Analisi Dettagliata: `_create_token_view_for_example`

**File**: `comparison/advanced_visualizer.py`, linee 324-376

```python
def _create_token_view_for_example(self, result: Dict, methods: List[str], output_dir: str):
    """Create token-level view for a single example."""
    example_name = result['example_name']

    # Create bar chart showing anomaly counts per method
    buggy_counts = [result['buggy'][m]['num_anomalies'] for m in methods]
    correct_counts = [result['correct'][m]['num_anomalies'] for m in methods]

    fig = go.Figure()

    # ‚ùå SOLO BAR CHART - Nessuna visualizzazione token!
    fig.add_trace(go.Bar(
        name='Buggy Code',
        x=[self.method_names[m] for m in methods],
        y=buggy_counts,
        marker_color='#d62728',
        text=buggy_counts,
        textposition='auto'
    ))

    # ... altro codice bar chart
```

**Mancanza**: Questo crea solo un bar chart con conteggi. **NON mostra quali token specifici sono stati identificati come anomali**.

### üìä Esempio di Cosa Serve

#### Visualizzazione Corretta (MANCANTE):

```html
<!-- binary_search_missing_bounds_lecprompt_buggy.html -->
<h2>Binary Search - LecPrompt - Buggy Code</h2>

<pre>
def binary_search(arr, target):
    <span style="background-color: #90ee90;">left</span> = <span style="background-color: #90ee90;">0</span>
    <span style="background-color: #ffcccc;">right</span> = <span style="background-color: #ffcccc;">len</span>(<span style="background-color: #90ee90;">arr</span>)  ‚Üê ANOMALY: missing -1

    while <span style="background-color: #90ee90;">left</span> <= <span style="background-color: #ffcccc;">right</span>:
        <span style="background-color: #90ee90;">mid</span> = ...
</pre>

<div class="legend">
    <span style="background-color: #ffcccc;">‚ñ†</span> High uncertainty (potential error)
    <span style="background-color: #90ee90;">‚ñ†</span> Low uncertainty (confident)
</div>
```

**Caratteristiche**:
- Codice completo con syntax preservation
- Token evidenziati con colori basati su incertezza
- Tooltip con metriche dettagliate al hover
- Legenda chiara con interpretazione

### üõ†Ô∏è Come Implementare

**Soluzione**: Usare `visualizer.py` che **GI√Ä HA** questa funzionalit√†!

**File**: `visualizer.py`, linee 253-480

```python
def create_html_visualization(self,
                            analyses: List[TokenAnalysis],
                            mode: str = TokenVisualizationMode.PROBABILITY,
                            title: str = "Token Analysis Visualization") -> str:
    """
    Create HTML visualization of tokens with color coding.
    """
    # ... codice che:
    # 1. Estrae valori per il mode selezionato
    # 2. Normalizza valori
    # 3. Crea HTML con token evidenziati
    # 4. Aggiunge tooltip con metriche
    # 5. Aggiunge legenda
```

**Modes supportati** (linee 159-200):
- `SEMANTIC_ENERGY` - Energia semantica (valori alti = ROSSO)
- `CONFORMAL_SCORE` - Score conformal (valori alti = ROSSO)
- `ATTENTION_ENTROPY` - Entropia attention (valori alti = ROSSO)
- `ATTENTION_ANOMALY_SCORE` - Score anomalia attention
- `LOGICAL_ERROR_DETECTION` - Rilevamento errori LecPrompt

**Ma questo non viene chiamato per generare le visualizzazioni per ogni metodo!**

### üìù Implementazione Necessaria

**Nuovo file**: `comparison/token_level_visualizer.py`

```python
class TokenLevelVisualizer:
    """
    Generate token-level HTML visualizations for each method on each example.
    """

    def generate_all_token_visualizations(self, results: Dict, output_dir: str):
        """
        Generate token-level visualizations for all methods on all examples.

        Genera:
        - {example}_lecprompt_buggy.html
        - {example}_lecprompt_correct.html
        - {example}_semantic_energy_buggy.html
        - {example}_semantic_energy_correct.html
        - {example}_conformal_buggy.html
        - {example}_conformal_correct.html
        - {example}_attention_buggy.html
        - {example}_attention_correct.html

        Per ogni esempio (10 esempi √ó 4 metodi √ó 2 versioni = 80 file HTML)
        """

        visualizer = TokenVisualizer()

        for result in results['individual_results']:
            example_name = result['example_name']

            # 1. LecPrompt
            self._generate_method_html(
                visualizer,
                result,
                'lecprompt',
                TokenVisualizationMode.LOGICAL_ERROR_DETECTION,
                output_dir
            )

            # 2. Semantic Energy
            self._generate_method_html(
                visualizer,
                result,
                'semantic_energy',
                TokenVisualizationMode.SEMANTIC_ENERGY,
                output_dir
            )

            # 3. Conformal Prediction
            self._generate_method_html(
                visualizer,
                result,
                'conformal',
                TokenVisualizationMode.CONFORMAL_SCORE,
                output_dir
            )

            # 4. Attention Anomaly
            self._generate_method_html(
                visualizer,
                result,
                'attention',
                TokenVisualizationMode.ATTENTION_ANOMALY_SCORE,
                output_dir
            )

    def _generate_method_html(self, visualizer, result, method, mode, output_dir):
        """Generate HTML for a single method on buggy and correct code."""
        example_name = result['example_name']

        # Buggy version
        buggy_analyses = self._get_token_analyses(result, method, 'buggy')
        buggy_html = visualizer.create_html_visualization(
            buggy_analyses,
            mode=mode,
            title=f"{example_name} - {method} - Buggy Code"
        )

        filename = f"{example_name}_{method}_buggy.html"
        self._save_html(buggy_html, os.path.join(output_dir, filename))

        # Correct version
        correct_analyses = self._get_token_analyses(result, method, 'correct')
        correct_html = visualizer.create_html_visualization(
            correct_analyses,
            mode=mode,
            title=f"{example_name} - {method} - Correct Code"
        )

        filename = f"{example_name}_{method}_correct.html"
        self._save_html(correct_html, os.path.join(output_dir, filename))

    def _get_token_analyses(self, result, method, code_type):
        """
        Estrae i TokenAnalysis dal result per il metodo e tipo di codice specificati.

        PROBLEMA: Attualmente i risultati NON contengono TokenAnalysis objects!
        Contengono solo conteggi aggregati.

        Serve modificare AdvancedMethodsComparator per salvare anche gli analyses.
        """
        # TODO: Implementare estrazione da result
        pass
```

### üîÑ Modifiche Necessarie

**1. Modificare `detectors/advanced_methods.py`**

Linee 721-850 (`AdvancedMethodsComparator.compare_all_methods`)

```python
# ATTUALMENTE ritorna solo conteggi:
result = {
    'method': 'semantic_energy',
    'num_tokens': 50,
    'num_anomalies': 7,
    'statistics': {...}
}

# DOVREBBE ritornare ANCHE:
result = {
    'method': 'semantic_energy',
    'num_tokens': 50,
    'num_anomalies': 7,
    'statistics': {...},
    'token_analyses': [...],  # ‚Üê AGGIUNGERE: Lista di TokenAnalysis
    'anomalous_positions': [3, 7, 12, ...],  # ‚Üê AGGIUNGERE: Posizioni anomale
    'code': "def binary_search(...)..."  # ‚Üê AGGIUNGERE: Codice originale
}
```

**2. Modificare `comparison/advanced_comparison_runner.py`**

Linee 192-282 (`run_comparison_on_example`)

```python
# Salvare gli analyses completi:
result = {
    'example_name': example.name,
    'buggy': {
        'lecprompt': {
            **self._extract_method_summary(buggy_comparison.lecprompt_result),
            'analyses': buggy_lecprompt_analyses,  # ‚Üê NUOVO
            'code': example.buggy_code  # ‚Üê NUOVO
        },
        # ... altri metodi
    },
    'correct': {
        # ... stessa struttura
    }
}
```

**3. Chiamare TokenLevelVisualizer in `test_advanced_methods.py`**

```python
# Dopo advanced_visualizer
if not args.skip_visualizations:
    # Visualizzazioni comparative (esistenti)
    visualizer = AdvancedMethodsVisualizer()
    visualizer.create_all_visualizations(results, args.output)

    # NUOVO: Visualizzazioni token-level
    token_visualizer = TokenLevelVisualizer()
    token_visualizer.generate_all_token_visualizations(results, args.output)
```

### üìä Impatto

| Aspetto | Stato Attuale | Dopo Fix |
|---------|---------------|----------|
| **Visualizzazione token** | ‚ùå Assente | ‚úÖ 80 HTML per tutte le combinazioni |
| **Confronto visivo metodi** | ‚ùå Impossibile | ‚úÖ Side-by-side per metodo |
| **Identificazione token specifici** | ‚ùå Solo conteggi | ‚úÖ Evidenziazione precisa |
| **Comprensione utente** | ‚ùå Limitata | ‚úÖ Completa |

**Severit√†**: üî¥ **CRITICO** - Senza queste visualizzazioni, gli utenti non possono vedere **quali** token sono stati identificati

---

## PROBLEMA #2: Manca index.html principale (ALTO)

### üü° Problema Identificato

**Gravit√†**: üü° **ALTO**

Esiste un `index.html` solo per `advanced_visualizations/` ma **manca un index.html principale** che permetta di navigare facilmente tra:
- Visualizzazioni comparative (7 esistenti)
- Visualizzazioni token-level (80 mancanti)
- Risultati JSON
- Report

### üìÅ Stato Attuale

**File esistente**: `advanced_visualizations/index.html`

Mostra solo:
- Link alle 7 visualizzazioni comparative
- Link ai token_level_multimethod_view (che sono bar chart, NON token evidenziati)

**Mancante**: Index principale a livello di `output_dir/`

### üìù Struttura Directory Desiderata

```
advanced_methods_comparison/
‚îú‚îÄ‚îÄ index.html  ‚Üê MANCANTE! Index principale
‚îú‚îÄ‚îÄ complete_comparison_results.json
‚îÇ
‚îú‚îÄ‚îÄ advanced_visualizations/  ‚Üê Visualizzazioni comparative
‚îÇ   ‚îú‚îÄ‚îÄ index.html  ‚Üê Esiste
‚îÇ   ‚îú‚îÄ‚îÄ methods_comparison_heatmap.html
‚îÇ   ‚îú‚îÄ‚îÄ anomaly_counts_comparison.html
‚îÇ   ‚îú‚îÄ‚îÄ method_agreement_matrix.html
‚îÇ   ‚îú‚îÄ‚îÄ method_performance_radar.html
‚îÇ   ‚îú‚îÄ‚îÄ venn_diagram_overlap.html
‚îÇ   ‚îú‚îÄ‚îÄ interactive_method_explorer.html
‚îÇ   ‚îî‚îÄ‚îÄ token_level_multimethod_view_*.html (√ó10)
‚îÇ
‚îî‚îÄ‚îÄ token_visualizations/  ‚Üê NUOVO! Visualizzazioni token-level
    ‚îú‚îÄ‚îÄ index.html  ‚Üê NUOVO! Organizza per metodo/esempio
    ‚îÇ
    ‚îú‚îÄ‚îÄ by_method/  ‚Üê Organizzato per metodo
    ‚îÇ   ‚îú‚îÄ‚îÄ lecprompt/
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ binary_search_buggy.html
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ binary_search_correct.html
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ... (√ó20 file)
    ‚îÇ   ‚îú‚îÄ‚îÄ semantic_energy/
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ... (√ó20 file)
    ‚îÇ   ‚îú‚îÄ‚îÄ conformal/
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ... (√ó20 file)
    ‚îÇ   ‚îî‚îÄ‚îÄ attention/
    ‚îÇ       ‚îî‚îÄ‚îÄ ... (√ó20 file)
    ‚îÇ
    ‚îî‚îÄ‚îÄ by_example/  ‚Üê Organizzato per esempio
        ‚îú‚îÄ‚îÄ binary_search/
        ‚îÇ   ‚îú‚îÄ‚îÄ lecprompt_buggy.html
        ‚îÇ   ‚îú‚îÄ‚îÄ lecprompt_correct.html
        ‚îÇ   ‚îú‚îÄ‚îÄ semantic_energy_buggy.html
        ‚îÇ   ‚îú‚îÄ‚îÄ semantic_energy_correct.html
        ‚îÇ   ‚îú‚îÄ‚îÄ conformal_buggy.html
        ‚îÇ   ‚îú‚îÄ‚îÄ conformal_correct.html
        ‚îÇ   ‚îú‚îÄ‚îÄ attention_buggy.html
        ‚îÇ   ‚îî‚îÄ‚îÄ attention_correct.html
        ‚îî‚îÄ‚îÄ ... (√ó10 cartelle)
```

### üõ†Ô∏è Index.html Principale Necessario

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Advanced Methods Comparison - Main Index</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .section {
            margin: 30px 0;
            padding: 20px;
            border: 2px solid #ddd;
            border-radius: 10px;
        }
        h1 { color: #333; }
        h2 { color: #555; border-bottom: 2px solid #4CAF50; padding-bottom: 10px; }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        .card {
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            transition: transform 0.3s;
        }
        .card:hover { transform: translateY(-5px); }
    </style>
</head>
<body>
    <h1>üî¨ Advanced Error Detection Methods - Complete Results</h1>

    <div class="section">
        <h2>üìä Comparative Visualizations</h2>
        <p>High-level comparisons across all methods and examples</p>
        <div class="grid">
            <a href="advanced_visualizations/index.html" class="card">
                <h3>üéØ All Comparative Views</h3>
                <p>Interactive dashboards, heatmaps, and performance radars</p>
            </a>
            <a href="advanced_visualizations/interactive_method_explorer.html" class="card">
                <h3>üîç Quick Explorer</h3>
                <p>Interactive method comparison dashboard</p>
            </a>
        </div>
    </div>

    <div class="section">
        <h2>üé® Token-Level Visualizations</h2>
        <p>Detailed code highlighting showing exact token anomalies</p>
        <div class="grid">
            <a href="token_visualizations/by_method/index.html" class="card">
                <h3>üìã Browse by Method</h3>
                <p>See all examples for each detection method</p>
            </a>
            <a href="token_visualizations/by_example/index.html" class="card">
                <h3>üéØ Browse by Example</h3>
                <p>Compare all methods on each test example</p>
            </a>
        </div>
    </div>

    <div class="section">
        <h2>üìÅ Raw Data</h2>
        <div class="grid">
            <a href="complete_comparison_results.json" class="card">
                <h3>üíæ Complete Results (JSON)</h3>
                <p>Full dataset with all metrics and analyses</p>
            </a>
        </div>
    </div>
</body>
</html>
```

### üìä Impatto

| Aspetto | Stato Attuale | Dopo Fix |
|---------|---------------|----------|
| **Navigazione principale** | ‚ùå Mancante | ‚úÖ Index chiaro |
| **Accesso visualizzazioni** | ‚ö†Ô∏è Disperso | ‚úÖ Centralizzato |
| **Organizzazione** | ‚ö†Ô∏è Confusa | ‚úÖ Strutturata |
| **User experience** | ‚ùå Difficile | ‚úÖ Intuitiva |

**Severit√†**: üü° **ALTO** - Difficile navigare i risultati senza index principale

---

## PROBLEMA #3: Nessuna integrazione tra visualizer.py e advanced methods (ALTO)

### üü° Problema Identificato

**Gravit√†**: üü° **ALTO**

`visualizer.py` ha **gi√† implementato** la logica per visualizzare token evidenziati per le metriche avanzate, MA **non viene mai chiamato** per generare le visualizzazioni per ogni metodo su ogni esempio.

### üìÅ Codice Esistente (NON UTILIZZATO)

**File**: `visualizer.py`

**Supporto metodi avanzati** (linee 39-46, 159-200):

```python
class TokenVisualizationMode:
    # ... altri mode

    # Advanced methods from METHODS_OVERVIEW.md
    SEMANTIC_ENERGY = "semantic_energy"  # Method 2
    CONFORMAL_SCORE = "conformal_score"  # Method 3
    ATTENTION_ENTROPY = "attention_entropy"  # Method 4
    ATTENTION_SELF_ATTENTION = "attention_self_attention"
    ATTENTION_VARIANCE = "attention_variance"
    ATTENTION_ANOMALY_SCORE = "attention_anomaly_score"
    SUSPICION_SCORE = "suspicion_score"
```

**Color schemes corretti** (linee 159-200):

```python
self.color_schemes = {
    TokenVisualizationMode.SEMANTIC_ENERGY: {
        'colormap': 'RdYlBu',
        'label': 'Semantic Energy (pre-softmax)',
        'reverse': True,  # ‚úÖ CORRETTO: Alto = incerto = ROSSO
        'description': 'Energy = -logit(token), higher = more uncertain'
    },
    TokenVisualizationMode.CONFORMAL_SCORE: {
        'colormap': 'RdYlBu',
        'label': 'Conformal Prediction Score',
        'reverse': True,  # ‚úÖ CORRETTO: Alto = incerto = ROSSO
        'description': 'Conformal score = 1 - P(token), higher = larger prediction set'
    },
    TokenVisualizationMode.ATTENTION_ENTROPY: {
        'colormap': 'RdYlBu',
        'label': 'Attention Entropy',
        'reverse': True,  # ‚úÖ CORRETTO: Alto = incerto = ROSSO
        'description': 'Entropy of attention distribution, higher = more uncertain'
    },
    TokenVisualizationMode.ATTENTION_SELF_ATTENTION: {
        'colormap': 'RdYlGn',
        'label': 'Self-Attention Weight',
        'reverse': False,  # ‚úÖ CORRETTO: Basso = anomalo = ROSSO
        'description': 'Self-attention weight (a_ii), lower = potentially anomalous'
    },
    # ...
}
```

**Estrazione valori** (linee 311-325):

```python
def create_html_visualization(self, analyses, mode, title):
    # ...

    # Advanced methods from METHODS_OVERVIEW.md
    elif mode == TokenVisualizationMode.SEMANTIC_ENERGY:
        values = [analysis.semantic_energy if analysis.semantic_energy is not None
                 else -analysis.logit for analysis in analyses]
    elif mode == TokenVisualizationMode.CONFORMAL_SCORE:
        values = [analysis.conformal_score if analysis.conformal_score is not None
                 else 1.0 - analysis.probability for analysis in analyses]
    elif mode == TokenVisualizationMode.ATTENTION_ENTROPY:
        values = [analysis.attention_entropy if analysis.attention_entropy is not None
                 else 0.0 for analysis in analyses]
    # ...
```

### ‚ùå Problema: MAI CHIAMATO

**Nessun codice chiama** `visualizer.create_html_visualization()` con questi mode per gli advanced methods!

**Cosa succede attualmente**:

1. `test_advanced_methods.py` ‚Üí `AdvancedMethodsComparisonRunner`
2. `AdvancedMethodsComparisonRunner` ‚Üí `AdvancedMethodsComparator.compare_all_methods()`
3. `compare_all_methods()` ‚Üí Esegue i 4 metodi, salva **solo conteggi**
4. `AdvancedMethodsVisualizer.create_all_visualizations()` ‚Üí Crea bar chart/heatmap
5. **FINE** - Nessuna chiamata a `visualizer.create_html_visualization()`

### üõ†Ô∏è Integrazione Necessaria

**1. Salvare TokenAnalysis negli advanced methods**

```python
# detectors/advanced_methods.py - SemanticEnergyDetector

def analyze_code(self, code, model, tokenizer, baseline_log_probs):
    """Analizza codice con semantic energy."""

    # Compute energies
    energies = self._compute_energies(...)

    # Detect anomalies
    anomalies, stats = self.detect_anomalies(energies)

    # ‚úÖ NUOVO: Crea TokenAnalysis objects
    from LLM import TokenAnalysis

    token_analyses = []
    for i, (token, energy, is_anom) in enumerate(zip(tokens, energies, anomalies)):
        analysis = TokenAnalysis(
            token=token,
            position=i,
            probability=exp(-energy),  # Converti da energy
            logit=-energy,
            semantic_energy=energy,  # ‚Üê METRICA PRINCIPALE
            # ... altre metriche di base
        )
        token_analyses.append(analysis)

    return {
        'method': 'semantic_energy',
        'num_tokens': len(tokens),
        'num_anomalies': sum(anomalies),
        'token_analyses': token_analyses,  # ‚Üê NUOVO!
        'code': code,  # ‚Üê NUOVO!
        # ...
    }
```

**2. Usare visualizer per generare HTML**

```python
# NUOVO: comparison/token_level_visualizer.py

from visualizer import TokenVisualizer, TokenVisualizationMode

class TokenLevelVisualizer:

    def generate_for_method(self, result, method, code_type, output_dir):
        """Generate token visualization for a method."""

        # Map method to visualization mode
        mode_map = {
            'lecprompt': TokenVisualizationMode.LOGICAL_ERROR_DETECTION,
            'semantic_energy': TokenVisualizationMode.SEMANTIC_ENERGY,
            'conformal': TokenVisualizationMode.CONFORMAL_SCORE,
            'attention': TokenVisualizationMode.ATTENTION_ANOMALY_SCORE
        }

        # Get token analyses
        analyses = result[code_type][method]['token_analyses']
        code = result[code_type][method]['code']

        # Create visualization
        visualizer = TokenVisualizer()
        html = visualizer.create_html_visualization(
            analyses,
            mode=mode_map[method],
            title=f"{result['example_name']} - {method} - {code_type}"
        )

        # Save to file
        filename = f"{result['example_name']}_{method}_{code_type}.html"
        self._save_html(html, os.path.join(output_dir, filename))
```

### üìä Impatto

| Aspetto | Stato Attuale | Dopo Fix |
|---------|---------------|----------|
| **Codice riutilizzato** | ‚ùå visualizer.py ignorato | ‚úÖ Utilizzato pienamente |
| **Duplicazione logica** | ‚ö†Ô∏è Rischio alto | ‚úÖ Singola implementazione |
| **Manutenibilit√†** | ‚ùå Difficile | ‚úÖ Centralizzata |
| **Consistenza** | ‚ö†Ô∏è Non garantita | ‚úÖ Stessi colori/logica |

**Severit√†**: üü° **ALTO** - Spreco di codice esistente e funzionante

---

## ‚úÖ OK: Logica di evidenziazione token √® corretta

### üü¢ Verifica Completata

**Gravit√†**: üü¢ **NESSUNA** - Tutto corretto

La logica di evidenziazione nel `visualizer.py` √® **CORRETTA** per tutte le tecniche.

### ‚úÖ Verifica: Reverse Flag

**File**: `visualizer.py`, linee 60-200

| Metodo | Reverse | Interpretazione | Corretto? |
|--------|---------|-----------------|-----------|
| **Semantic Energy** | `True` | Alto = incerto = **ROSSO** | ‚úÖ S√¨ |
| **Conformal Score** | `True` | Alto = incerto = **ROSSO** | ‚úÖ S√¨ |
| **Attention Entropy** | `True` | Alto = incerto = **ROSSO** | ‚úÖ S√¨ |
| **Attention Self-Attention** | `False` | Basso = anomalo = **ROSSO** | ‚úÖ S√¨ |
| **Attention Variance** | `True` | Alto = erratico = **ROSSO** | ‚úÖ S√¨ |
| **Attention Anomaly Score** | `True` | Alto = anomalo = **ROSSO** | ‚úÖ S√¨ |
| **LecPrompt Error** | `True` | Alto = errore = **ROSSO** | ‚úÖ S√¨ |

### üìö Spiegazione Tecnica

**Semantic Energy** (Farquhar et al., NeurIPS 2024):
```
Energy = -logit(token)
Alto energy ‚Üí Basso logit ‚Üí Bassa confidence ‚Üí INCERTO ‚Üí ROSSO ‚úÖ
reverse=True ‚Üí normalize inverte scala ‚Üí Funziona correttamente
```

**Conformal Score** (Quach et al., ICLR 2024):
```
Score = 1 - P(token)
Alto score ‚Üí Bassa probabilit√† ‚Üí INCERTO ‚Üí ROSSO ‚úÖ
reverse=True ‚Üí Funziona correttamente
```

**Attention Entropy** (Ott et al., ICML 2018):
```
Entropia alta ‚Üí Distribuzione uniforme ‚Üí Attenzione dispersa ‚Üí INCERTO ‚Üí ROSSO ‚úÖ
reverse=True ‚Üí Funziona correttamente
```

**Self-Attention Weight**:
```
Peso basso (token non attende a s√© stesso) ‚Üí ANOMALO ‚Üí ROSSO ‚úÖ
reverse=False ‚Üí Valori bassi diventano rossi ‚Üí Funziona correttamente
```

### üé® Color Mapping Corretto

**Codice**: `visualizer.py`, linee 204-236

```python
def _normalize_values(self, values: List[float], mode: str) -> List[float]:
    """Normalize values for color mapping."""
    values = np.array(values)

    # Normalize to [0, 1]
    min_val, max_val = np.min(values), np.max(values)
    normalized = (values - min_val) / (max_val - min_val)

    # ‚úÖ Reverse if needed
    if self.color_schemes[mode]['reverse']:
        normalized = 1 - normalized

    return normalized.tolist()
```

**Funzionamento**:

1. Normalizza a [0, 1]
2. Se `reverse=True`, inverte: `1 - normalized`
3. Applica colormap (es. RdYlBu: 0=Blu, 1=Rosso)

**Esempio Semantic Energy**:
```
Valori originali: [5.2, 8.1, 3.4, 9.5, 4.0]  (alto = incerto)
Normalizzati: [0.34, 0.83, 0.00, 1.00, 0.12]
Reversed: [0.66, 0.17, 1.00, 0.00, 0.88]  ‚Üê Ora alto originale ‚Üí basso ‚Üí BLU
                                             basso originale ‚Üí alto ‚Üí ROSSO ‚úÖ
```

**ERRATO!** Wait, c'√® un problema nella mia analisi. Rileggo...

Ah no, √® corretto:
- Valori originali alti (9.5 = molto incerto)
- Dopo normalize: 1.00
- Dopo reverse: 1 - 1.00 = 0.00
- Colormap[0.00] con RdYlBu = **ROSSO** ‚úÖ

Perfetto!

### üìä Verifica Visuale

**Tooltip completi** (linee 366-466):

```python
# Tooltip con TUTTE le metriche
tooltip_parts = [
    f"Token: {html.escape(analysis.token)}",
    f"Position: {analysis.position}",
    "",
    "=== Advanced Detection Methods ===",
    f"Semantic Energy: {analysis.semantic_energy:.4f}",  # ‚úÖ
    f"Conformal Score: {analysis.conformal_score:.4f}",  # ‚úÖ
    f"Attention Entropy: {analysis.attention_entropy:.4f}",  # ‚úÖ
    f"Self-Attention: {analysis.attention_self_attention:.4f}",  # ‚úÖ
    f"Attention Variance: {analysis.attention_variance:.4f}",  # ‚úÖ
    f"Attention Anomaly Score: {analysis.attention_anomaly_score:.4f}"  # ‚úÖ
]
```

**Legenda chiara** (linee 482-528):

```python
def _create_color_legend(self, scheme: Dict, values: List[float]) -> str:
    """Create a color legend for the visualization."""

    legend_html = [
        f"<p><strong>Legend ({scheme['label']}):</strong></p>",
        # ... gradient display
        f"<p><em>{scheme.get('description', '')}</em></p>"  # ‚úÖ Descrizione
    ]
```

**Descrizioni corrette**:
- Semantic Energy: "Energy = -logit(token), **higher = more uncertain**" ‚úÖ
- Conformal: "score = 1 - P(token), **higher = larger prediction set**" ‚úÖ
- Attention Entropy: "**higher = more uncertain**" ‚úÖ
- Self-Attention: "**lower = potentially anomalous**" ‚úÖ

### üìä Conclusione

| Componente | Stato | Note |
|------------|-------|------|
| **Reverse flags** | ‚úÖ Corretti | Tutti configurati bene |
| **Normalize logic** | ‚úÖ Corretta | Inversione funziona |
| **Color mapping** | ‚úÖ Corretto | RdYlBu usato bene |
| **Tooltip descriptions** | ‚úÖ Corrette | Chiare e precise |
| **Legend** | ‚úÖ Corretta | Con descrizioni |

**Severit√†**: üü¢ **NESSUN PROBLEMA** - Implementazione corretta

---

## üìä Riepilogo Complessivo

### Problemi per Severit√†

| Severit√† | # | Problema | Impatto |
|----------|---|----------|---------|
| üî¥ **CRITICO** | 1 | Manca visualizzazione token-level | Utenti non vedono token specifici |
| üü° **ALTO** | 2 | Manca index.html principale | Navigazione difficile |
| üü° **ALTO** | 3 | Nessuna integrazione visualizer.py | Codice non utilizzato |
| üü¢ **OK** | - | Logica evidenziazione | Tutto corretto ‚úÖ |

### File da Creare

| File | Scopo | Priorit√† |
|------|-------|----------|
| `comparison/token_level_visualizer.py` | Generare visualizzazioni token | üî¥ CRITICA |
| `index.html` (root) | Index principale | üü° ALTA |
| `token_visualizations/index.html` | Index token-level | üü° ALTA |
| `token_visualizations/by_method/index.html` | Browse per metodo | üü° ALTA |
| `token_visualizations/by_example/index.html` | Browse per esempio | üü° ALTA |

### File da Modificare

| File | Modifiche | Priorit√† |
|------|-----------|----------|
| `detectors/advanced_methods.py` | Salvare token_analyses | üî¥ CRITICA |
| `comparison/advanced_comparison_runner.py` | Passare analyses a results | üî¥ CRITICA |
| `test_advanced_methods.py` | Chiamare TokenLevelVisualizer | üî¥ CRITICA |

### Stima Implementazione

| Task | Linee Codice | Tempo Stimato |
|------|--------------|---------------|
| TokenLevelVisualizer | ~300 | 3-4 ore |
| Modifiche advanced_methods | ~100 | 1-2 ore |
| Modifiche comparison_runner | ~50 | 1 ora |
| Index HTML files | ~200 | 1-2 ore |
| Testing | - | 2-3 ore |
| **TOTALE** | **~650** | **8-12 ore** |

---

## üí° Raccomandazioni

### 1. PRIORIT√Ä MASSIMA: Implementare visualizzazione token-level

Senza questa, il sistema √® **incompleto** - gli utenti non possono vedere **quali** token sono stati identificati, rendendo i risultati molto meno utili.

### 2. ALTA PRIORIT√Ä: Creare index principale

Migliora significativamente la user experience e rende i risultati accessibili.

### 3. ALTA PRIORIT√Ä: Integrare visualizer.py

Riutilizza codice esistente e garantisce consistenza.

### 4. Testing: Verificare output HTML

Dopo implementazione, verificare:
- ‚úÖ Tutti i 80 file HTML generati
- ‚úÖ Token evidenziati correttamente
- ‚úÖ Colori secondo interpretazione corretta
- ‚úÖ Tooltip funzionanti
- ‚úÖ Legende chiare
- ‚úÖ Navigazione funzionante

---

**Documento creato**: 2025-01-19
**Versione**: 1.0
**Autore**: Analisi automatica codice
